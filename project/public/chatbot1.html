<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë””ì €íŠ¸ì¹´í˜ ì¶”ì²œ ì±—ë´‡</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header.topbar {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: #ffffff;
      border-bottom: 1px solid #e5e5e5;
    }

    .logo {
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
    }

    .top-actions button {
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #2f80ed;
      background: #ffffff;
      color: #2f80ed;
      font-size: 13px;
      cursor: pointer;
    }
    
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px 28px 32px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }
    h1 {
      margin-top: 0;
      font-size: 24px;
    }
    .desc {
      color: #666;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .input-row input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .input-row button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: #2f80ed;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }
    .input-row button:disabled {
      background: #999;
      cursor: default;
    }
    .status {
      font-size: 13px;
      color: #999;
      min-height: 18px;
      margin-bottom: 12px;
    }
    .prefs {
      font-size: 13px;
      background: #f0f4ff;
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 16px;
      white-space: pre-line;
    }
    .results {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      border-radius: 10px;
      padding: 12px 14px;
      background: #fafafa;
      border: 1px solid #e3e3e3;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .card-title {
      font-weight: 600;
      font-size: 15px;
    }
    .card-region {
      font-size: 12px;
      color: #666;
    }
    .card-score {
      font-size: 13px;
      color: #2f80ed;
      font-weight: 600;
    }
    .card-line {
      font-size: 13px;
      margin-top: 6px;
    }
    .card-label {
      font-weight: 600;
      color: #555;
    }
    .card-summary {
      margin-top: 6px;
      font-size: 13px;
      color: #444;
    }
    .card-url a {
      font-size: 12px;
      color: #2f80ed;
      text-decoration: none;
    }
    .card-url a:hover {
      text-decoration: underline;
    }
    /* âœ… ì±„íŒ… ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .chat-box {
      margin-top: 16px;
      margin-bottom: 16px;
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid #eee;
      font-size: 14px;
    }

    .chat-msg {
      display: flex;
      margin-bottom: 8px;
    }

    .chat-msg.user {
      justify-content: flex-end;
    }

    .chat-msg.bot {
      justify-content: flex-start;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 16px;
      word-break: break-word;
      line-height: 1.4;
    }

    .chat-msg.user .chat-bubble {
      background: #2f80ed;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .chat-msg.bot .chat-bubble {
      background: #eee;
      color: #222;
      border-bottom-left-radius: 4px;
    }

  </style>
</head>
<body>
    
    <!-- ìƒë‹¨ë°” -->
    <header class="topbar">
      <div class="logo" onclick="location.href='/'">
        ê´‘ì£¼Â·ì „ë‚¨ ë””ì €íŠ¸ì¹´í˜ ì§€ë„ 
        </div>
      <div class="top-actions">
        <button onclick="location.href='/join.html'">íšŒì›ê°€ì…</button>
        <button onclick="location.href='/login.html'">ë¡œê·¸ì¸</button>
      </div>
    </header>
    
  <div class="container">
    <h1>ë””ì €íŠ¸ì¹´í˜ ì¶”ì²œ ì±—ë´‡</h1>
    <div class="desc">
      ì˜ˆì‹œ) <code>ê´‘ì£¼ì—ì„œ ì‚¬ì§„ì°ê¸° ì¢‹ì€ ë¶„ìœ„ê¸°ì˜ ì»¤í”¼ê°€ ë§›ìˆëŠ” ì¹´í˜ ì¶”ì²œí•´ì¤˜</code><br />
      ì§€ì—­, ë¶„ìœ„ê¸°, ì»¤í”¼/ë””ì €íŠ¸ í‚¤ì›Œë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì²œí•´ì¤˜ìš”.
    </div>

    <div class="input-row">
      <input
        id="queryInput"
        type="text"
        placeholder="ì›í•˜ëŠ” ì¹´í˜ë¥¼ ìì—°ì–´ë¡œ ì ì–´ë³´ì„¸ìš” :)"
      />
      <button id="sendBtn">ì¶”ì²œ ë°›ê¸°</button>
    </div>

    <div id="chatBox" class="chat-box"></div>

    <div class="status" id="statusText"></div>
    <div class="prefs" id="prefsBox" style="display:none;"></div>

    <div class="results" id="resultsBox"></div>
  </div>

  

  <script>
    const queryInput = document.getElementById("queryInput");
    const sendBtn = document.getElementById("sendBtn");
    const statusText = document.getElementById("statusText");
    const prefsBox = document.getElementById("prefsBox");
    const resultsBox = document.getElementById("resultsBox");
    const chatBox = document.getElementById("chatBox");
    let lastPrefs = null;

    // âœ… ì±„íŒ… ë²„ë¸” ì¶”ê°€ í•¨ìˆ˜
    function appendMessage(sender, text) {
      if (!text) return;

      const msg = document.createElement("div");
      msg.className = `chat-msg ${sender}`;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.textContent = text;

      msg.appendChild(bubble);
      chatBox.appendChild(msg);

      // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendQuery() {
      const message = queryInput.value.trim();
      if (!message) {
        alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
        return;
      }
      
      appendMessage("user", message);

      sendBtn.disabled = true;
      statusText.textContent = "ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤...";
      // prefsBox.style.display = "none";
      // prefsBox.textContent = "";
      resultsBox.innerHTML = "";

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message })
        });

        if (!res.ok) {
          throw new Error("ì„œë²„ ì—ëŸ¬: " + res.status);
        }

        const data = await res.json();
        console.log("ì‘ë‹µ:", data);

         // âœ… Geminiê°€ ë§Œë“¤ì–´ ì¤€ ìì—°ì–´ ë‹µë³€ì„ ë´‡ ë©”ì‹œì§€ë¡œ í‘œì‹œ
        const botMessage =
          data.message ||
          "ì¡°ê±´ì— ë§ëŠ” ì¹´í˜ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ë‹¤ì‹œ í•œ ë²ˆ ìš”ì²­í•´ ì£¼ì„¸ìš” :)";
        appendMessage("bot", botMessage);

        // prefs í‘œì‹œ
        const prefs = data.prefs || {};
        const region = (prefs.region || []).join(", ") || "-";
        const atmosphere = (prefs.atmosphere || []).join(", ") || "-";
        const taste = (prefs.taste || []).join(", ") || "-";
        const purpose = (prefs.purpose || []).join(", ") || "-";

        // prefsBox.style.display = "block";
        // prefsBox.textContent =
        //   `ì¸ì‹ëœ ì„ í˜¸ë„\n` +
        //   `â€¢ ì§€ì—­: ${region}\n` +
        //   `â€¢ ë¶„ìœ„ê¸°: ${atmosphere}\n` +
        //   `â€¢ ë§›/ë©”ë‰´: ${taste}\n` +
        //   `â€¢ ëª©ì : ${purpose}`;

        // ê²°ê³¼ ì¹´ë“œ ë Œë”ë§
        const results = data.results || [];
        if (results.length === 0) {
          resultsBox.innerHTML = "<div>ì¡°ê±´ì— ë§ëŠ” ì¹´í˜ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš” ğŸ¥¹</div>";
        } else {
          for (const cafe of results) {
            const card = document.createElement("div");
            card.className = "card";

            const header = document.createElement("div");
            header.className = "card-header";

            const left = document.createElement("div");
            const title = document.createElement("div");
            title.className = "card-title";
            title.textContent = cafe.name;

            const regionSpan = document.createElement("div");
            regionSpan.className = "card-region";
            regionSpan.textContent = cafe.region || "";

            left.appendChild(title);
            left.appendChild(regionSpan);

            const score = document.createElement("div");
            score.className = "card-score";
            const scoreVal = cafe.score != null ? cafe.score.toFixed(2) : "0.00";
            score.textContent = `ì ìˆ˜: ${scoreVal}`;

            header.appendChild(left);
            header.appendChild(score);
            card.appendChild(header);

            // ì£¼ì†Œ
            const addrLine = document.createElement("div");
            addrLine.className = "card-line";
            addrLine.innerHTML = `<span class="card-label">ì£¼ì†Œ</span> ${cafe.address || ""}`;
            card.appendChild(addrLine);

            // ë¶„ìœ„ê¸°
            const atmLine = document.createElement("div");
            atmLine.className = "card-line";
            atmLine.innerHTML = `<span class="card-label">ë¶„ìœ„ê¸°</span> ${(cafe.atmosphere || "").replace(/\|/g, ", ")}`;
            card.appendChild(atmLine);

            // ë§›/ë©”ë‰´
            const tasteLine = document.createElement("div");
            tasteLine.className = "card-line";
            tasteLine.innerHTML = `<span class="card-label">ë§›/ë©”ë‰´</span> ${(cafe.taste || "").replace(/\|/g, ", ")}`;
            card.appendChild(tasteLine);

            // ëª©ì 
            if (cafe.purpose) {
              const purposeLine = document.createElement("div");
              purposeLine.className = "card-line";
              purposeLine.innerHTML =
                `<span class="card-label">ëª©ì </span> ${(cafe.purpose || "").replace(/\|/g, ", ")}`;
              card.appendChild(purposeLine);
            }

            // ë™ë°˜ì¸
            if (cafe.companion) {
              const compLine = document.createElement("div");
              compLine.className = "card-line";
              compLine.innerHTML =
                `<span class="card-label">ë™ë°˜ì¸</span> ${(cafe.companion || "").replace(/\|/g, ", ")}`;
              card.appendChild(compLine);
            }

            // ë©”ë‰´
            if (cafe.menu) {
              const menuLine = document.createElement("div");
              menuLine.className = "card-line";
              menuLine.innerHTML =
                `<span class="card-label">ë©”ë‰´</span> ${cafe.menu.replace(/[|;]/g, ", ")}`;
              card.appendChild(menuLine);
            }

            // ëŒ€í‘œ ë””ì €íŠ¸
            if (cafe.main_dessert) {
              const mdLine = document.createElement("div");
              mdLine.className = "card-line";
              mdLine.innerHTML =
                `<span class="card-label">ëŒ€í‘œ ë””ì €íŠ¸</span> ${cafe.main_dessert}`;
              card.appendChild(mdLine);
            }

            // ëŒ€í‘œ ì»¤í”¼
            if (cafe.main_coffee) {
              const mcLine = document.createElement("div");
              mcLine.className = "card-line";
              mcLine.innerHTML =
                `<span class="card-label">ëŒ€í‘œ ì»¤í”¼</span> ${cafe.main_coffee}`;
              card.appendChild(mcLine);
            }

            // ì£¼ì°¨
            if (cafe.parking) {
              const parkingLine = document.createElement("div");
              parkingLine.className = "card-line";
              parkingLine.innerHTML =
                `<span class="card-label">ì£¼ì°¨</span> ${cafe.parking}`;
              card.appendChild(parkingLine);
            }

            // ìš”ì•½
            if (cafe.summary) {
              const summaryLine = document.createElement("div");
              summaryLine.className = "card-summary";
              summaryLine.textContent = cafe.summary;
              card.appendChild(summaryLine);
            }

            // URL
            if (cafe.url) {
              const urlLine = document.createElement("div");
              urlLine.className = "card-line card-url";
              urlLine.innerHTML = `<a href="${cafe.url}" target="_blank">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>`;
              card.appendChild(urlLine);
            }

            resultsBox.appendChild(card);
          }
        }

        statusText.textContent = "ì¶”ì²œ ì™„ë£Œ âœ”";
      } catch (err) {
        console.error(err);
        statusText.textContent = "ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        alert("ì˜¤ë¥˜: " + err.message);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendQuery);
    queryInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendQuery();
      }
    });
  </script>
</body>
</html>
