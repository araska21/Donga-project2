<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë””ì €íŠ¸ì¹´í˜ ì¶”ì²œ ì±—ë´‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo" onclick="location.href='/'">
      <div class="logo-mark"></div>
      <div>
        ë‹¬ì½¤ ì¸ë±ìŠ¤
        <div class="logo-sub">ë‹¬ì½¤í•œ ë¦¬ë·°ë¥¼, í•œëˆˆì— ì¸ë±ìŠ¤</div>
      </div>
    </div>
    <div class="top-nav">
      <a href="/map.html">ì§€ë„ ê²€ìƒ‰</a>
      <a href="/chatbot.html">ì±—ë´‡ ì¶”ì²œ</a>
      <div class="top-actions">
        <button onclick="location.href='/login.html'">ë¡œê·¸ì¸</button>
        <button class="primary" onclick="location.href='/join.html'">íšŒì›ê°€ì…</button>
      </div>
    </div>
  </header>

  <div class="chat-container">
    <h1 class="chat-title">ëŒ€í™”í˜• ë””ì €íŠ¸ì¹´í˜ ì¶”ì²œ</h1>
    <div class="chat-desc">
      ì˜ˆì‹œ)<br />
      Â· <code>ë‚˜ì£¼ ë¶„ìœ„ê¸° ì¢‹ì€ ì¹´í˜ ì¶”ì²œí•´ì¤˜</code><br />
      Â· <code>ê´‘ì£¼ì—ì„œ ì‚¬ì§„ ì°ê¸° ì¢‹ì€ ì¹´í˜ ì¤‘ì— ì»¤í”¼ ë§›ìˆëŠ” ê³³ ì•Œë ¤ì¤˜</code><br />
      Â· <code>ì¡°ìš©í•˜ê²Œ ê³µë¶€í•˜ê¸° ì¢‹ì€ ë””ì €íŠ¸ì¹´í˜</code><br />
      ì´ì „ì— ë§í•œ ì§€ì—­/ì¡°ê±´ì„ ê¸°ì–µí•´ì„œ ì´ì–´ì„œ ëŒ€í™”í•´ìš” ğŸ˜Š
    </div>

    <div class="input-row">
      <input
        id="queryInput"
        type="text"
        placeholder="ì›í•˜ëŠ” ì¹´í˜ë¥¼ ìì—°ì–´ë¡œ í¸í•˜ê²Œ ì ì–´ë³´ì„¸ìš” :)"
      />
      <button id="sendBtn">ë³´ë‚´ê¸°</button>
    </div>

    <div class="status" id="statusText"></div>

    <!-- âœ… ì±„íŒ… ë‚´ì—­ -->
    <div id="chatBox" class="chat-box"></div>

    <!-- ì¶”ì²œ ê²°ê³¼ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
    <div class="results" id="resultsBox"></div>
  </div>

  <script>
    const queryInput = document.getElementById("queryInput");
    const sendBtn = document.getElementById("sendBtn");
    const statusText = document.getElementById("statusText");
    const chatBox = document.getElementById("chatBox");
    const resultsBox = document.getElementById("resultsBox");

    // âœ… ë§ˆì§€ë§‰ìœ¼ë¡œ ì¸ì‹ëœ ì„ í˜¸ë„ (íŠ¹íˆ region)ë¥¼ ì €ì¥
    let lastPrefs = null;

    // region ì½”ë“œ â†’ í•œê¸€ ì´ë¦„ ë§¤í•‘
    const REGION_NAME_MAP = {
      gwangju: "ê´‘ì£¼",
      naju: "ë‚˜ì£¼",
      damyang: "ë‹´ì–‘",
      jangseong: "ì¥ì„±",
      hwasoon: "í™”ìˆœ"
    };

    // âœ… ì±„íŒ… ë²„ë¸” ì¶”ê°€ í•¨ìˆ˜
    function appendMessage(sender, text) {
      if (!text) return;

      const msg = document.createElement("div");
      msg.className = `chat-msg ${sender}`;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.textContent = text;

      msg.appendChild(bubble);
      chatBox.appendChild(msg);

      // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // âœ… ë©”ì‹œì§€ ì „ì†¡
    async function sendQuery() {
      const originalMessage = queryInput.value.trim();
      if (!originalMessage) {
        alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
        return;
      }

      // ì±„íŒ…ì°½ì—ëŠ” ì‚¬ìš©ìê°€ ì ì€ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ê¸°
      appendMessage("user", originalMessage);

      // ì„œë²„ë¡œ ë³´ë‚¼ ì‹¤ì œ ë©”ì‹œì§€ (ë§¥ë½ ë³´ì • í›„)
      let messageToSend = originalMessage;

      // ğŸ” ì´ì „ ì„ í˜¸ì— region ì´ ìˆê³ ,
      // ì´ë²ˆ ë©”ì‹œì§€ ì•ˆì— ì§€ì—­ ë‹¨ì–´(ê´‘ì£¼/ë‚˜ì£¼/ë‹´ì–‘/ì¥ì„±/í™”ìˆœ)ê°€ ì—†ìœ¼ë©´
      // ìë™ìœ¼ë¡œ "ë‚˜ì£¼ ~~" ê°™ì€ ì‹ìœ¼ë¡œ ì§€ì—­ì„ ë¶™ì—¬ì„œ ë³´ë‚¸ë‹¤.
      try {
        if (
          lastPrefs &&
          Array.isArray(lastPrefs.region) &&
          lastPrefs.region.length > 0 &&
          !/(ê´‘ì£¼|ë‚˜ì£¼|ë‹´ì–‘|ì¥ì„±|í™”ìˆœ)/.test(originalMessage)
        ) {
          const regionNames = lastPrefs.region
            .map((code) => REGION_NAME_MAP[code] || "")
            .filter(Boolean)
            .join(" ");

          if (regionNames) {
            messageToSend = `${regionNames} ${originalMessage}`;
            console.log(
              "[front] region ë§¥ë½ ì ìš©:",
              originalMessage,
              "â†’",
              messageToSend
            );
          }
        }
      } catch (e) {
        console.warn("ë§¥ë½ ì ìš© ì¤‘ ì˜¤ë¥˜(ë¬´ì‹œ ê°€ëŠ¥):", e);
      }

      sendBtn.disabled = true;
      statusText.textContent = "ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤...";
      resultsBox.innerHTML = "";

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message: messageToSend })
        });

        if (!res.ok) {
          throw new Error("ì„œë²„ ì—ëŸ¬: " + res.status);
        }

        const data = await res.json();
        console.log("ì‘ë‹µ:", data);

        // âœ… ë§ˆì§€ë§‰ prefs ì €ì¥ (ë‹¤ìŒ ì§ˆë¬¸ì— ë§¥ë½ìœ¼ë¡œ ì‚¬ìš©)
        if (data.prefs) {
          lastPrefs = data.prefs;
        }

        // âœ… ë´‡ì˜ ìì—°ì–´ ë‹µë³€
        const botMessage =
          data.message ||
          "ì¡°ê±´ì— ë§ëŠ” ì¹´í˜ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ë‹¤ì‹œ í•œ ë²ˆ ìš”ì²­í•´ ì£¼ì„¸ìš” :)";
        appendMessage("bot", botMessage);

        // âœ… ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        const results = data.results || [];
        if (results.length === 0) {
          const emptyDiv = document.createElement("div");
          emptyDiv.textContent =
            "ì¡°ê±´ì— ë”± ë§ëŠ” ì¹´í˜ëŠ” ì—†ì§€ë§Œ, ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ë‹¤ì‹œ í•œ ë²ˆ ë¬¼ì–´ë´ ì£¼ì„¸ìš”.";
          resultsBox.appendChild(emptyDiv);
        } else {
          for (const cafe of results) {
            const card = document.createElement("div");
            card.className = "card";

            const header = document.createElement("div");
            header.className = "card-header";

            const left = document.createElement("div");
            const title = document.createElement("div");
            title.className = "card-title";
            title.textContent = cafe.name;

            const regionSpan = document.createElement("div");
            regionSpan.className = "card-region";
            regionSpan.textContent = cafe.region || "";

            left.appendChild(title);
            left.appendChild(regionSpan);

            const score = document.createElement("div");
            score.className = "card-score";
            const scoreVal =
              typeof cafe.score === "number" && cafe.score > 0
                ? cafe.score.toFixed(2)
                : "ì ìˆ˜ ì •ë³´ ì—†ìŒ";
            score.textContent = scoreVal;

            header.appendChild(left);
            header.appendChild(score);
            card.appendChild(header);

            // ì£¼ì†Œ
            const addrLine = document.createElement("div");
            addrLine.className = "card-line";
            addrLine.innerHTML = `<span class="card-label">ì£¼ì†Œ</span> ${
              cafe.address || ""
            }`;
            card.appendChild(addrLine);

            // ë¶„ìœ„ê¸°
            if (cafe.atmosphere) {
              const atmLine = document.createElement("div");
              atmLine.className = "card-line";
              atmLine.innerHTML =
                `<span class="card-label">ë¶„ìœ„ê¸°</span> ` +
                cafe.atmosphere.replace(/\|/g, ", ");
              card.appendChild(atmLine);
            }

            // ë§›/ë©”ë‰´ íƒœê·¸
            if (cafe.taste) {
              const tasteLine = document.createElement("div");
              tasteLine.className = "card-line";
              tasteLine.innerHTML =
                `<span class="card-label">ë§›/ë©”ë‰´</span> ` +
                cafe.taste.replace(/\|/g, ", ");
              card.appendChild(tasteLine);
            }

            // ëª©ì 
            if (cafe.purpose) {
              const purposeLine = document.createElement("div");
              purposeLine.className = "card-line";
              purposeLine.innerHTML =
                `<span class="card-label">ëª©ì </span> ` +
                cafe.purpose.replace(/\|/g, ", ");
              card.appendChild(purposeLine);
            }

            // ë™ë°˜ì¸
            if (cafe.companion) {
              const compLine = document.createElement("div");
              compLine.className = "card-line";
              compLine.innerHTML =
                `<span class="card-label">ë™ë°˜ì¸</span> ` +
                cafe.companion.replace(/\|/g, ", ");
              card.appendChild(compLine);
            }

            // ë©”ë‰´
            if (cafe.menu) {
              const menuLine = document.createElement("div");
              menuLine.className = "card-line";
              menuLine.innerHTML =
                `<span class="card-label">ë©”ë‰´</span> ` +
                cafe.menu.replace(/[|;]/g, ", ");
              card.appendChild(menuLine);
            }

            // ëŒ€í‘œ ë””ì €íŠ¸
            if (cafe.main_dessert) {
              const mdLine = document.createElement("div");
              mdLine.className = "card-line";
              mdLine.innerHTML =
                `<span class="card-label">ëŒ€í‘œ ë””ì €íŠ¸</span> ${
                  cafe.main_dessert
                }`;
              card.appendChild(mdLine);
            }

            // ëŒ€í‘œ ì»¤í”¼
            if (cafe.main_coffee) {
              const mcLine = document.createElement("div");
              mcLine.className = "card-line";
              mcLine.innerHTML =
                `<span class="card-label">ëŒ€í‘œ ì»¤í”¼</span> ${
                  cafe.main_coffee
                }`;
              card.appendChild(mcLine);
            }

            // ì£¼ì°¨
            if (cafe.parking) {
              const pkLine = document.createElement("div");
              pkLine.className = "card-line";
              pkLine.innerHTML = `<span class="card-label">ì£¼ì°¨</span> ${
                cafe.parking
              }`;
              card.appendChild(pkLine);
            }

            if (cafe.url) {
              const urlLine = document.createElement("div");
              urlLine.className = "card-line card-url";
              urlLine.innerHTML = `<a href="${cafe.url}" target="_blank">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>`;
              card.appendChild(urlLine);
            }

            resultsBox.appendChild(card);
          }
        }

        statusText.textContent = "ì¶”ì²œ ì™„ë£Œ âœ”";
        queryInput.value = "";
      } catch (err) {
        console.error(err);
        statusText.textContent = "ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        alert("ì˜¤ë¥˜: " + err.message);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", sendQuery);
    queryInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendQuery();
      }
    });
  </script>
</body>
</html>
