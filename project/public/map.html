<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë””ì €íŠ¸ì¹´í˜ ì§€ë„</title>
  <link rel="stylesheet" href="/style.css" />

  <!-- ì¹´ì¹´ì˜¤ë§µ JS SDK (ë³¸ì¸ ì•±í‚¤ë¡œ êµì²´) -->
  <script src=""></script>
</head>h
<body>
  <div class="layout">
    <header class="topbar">
      <div class="logo" onclick="location.href='/'">
        <div class="logo-mark"></div>
        <div>
          ë‹¬ì½¤ ì¸ë±ìŠ¤
          <div class="logo-sub">ë‹¬ì½¤í•œ ë¦¬ë·°ë¥¼, í•œëˆˆì— ì¸ë±ìŠ¤</div>
        </div>
        <button class="sidebar-toggle" onclick="event.stopPropagation(); toggleSidebar()">í•„í„° ë‹«ê¸°</button>
      </div>
      <div class="top-actions">
        <button onclick="location.href='/chatbot.html'">ì±—ë´‡ ì¶”ì²œ</button>
        <button onclick="location.href='/login.html'">ë¡œê·¸ì¸</button>
        <button class="primary" onclick="location.href='/join.html'">íšŒì›ê°€ì…</button>
      </div>
    </header>

    <!-- ì™¼ìª½ í•„í„° ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <h2>í•„í„°</h2>

      <div class="filter-group">
        <div class="filter-group-title">ì§€ì—­</div>
        <div class="filter-options">
          <label><input type="checkbox" name="region" value="gwangju" /> ê´‘ì£¼</label>
          <label><input type="checkbox" name="region" value="naju" /> ë‚˜ì£¼</label>
          <label><input type="checkbox" name="region" value="damyang" /> ë‹´ì–‘</label>
          <label><input type="checkbox" name="region" value="janseong" /> ì¥ì„±</label>
          <label><input type="checkbox" name="region" value="hwasoon" /> í™”ìˆœ</label>
        </div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">ë¶„ìœ„ê¸°</div>
        <div class="filter-options">
          <label><input type="checkbox" name="atmosphere" value="ê°ì„±" /> ê°ì„±</label>
          <label><input type="checkbox" name="atmosphere" value="ì¡°ìš©í•œ" /> ì¡°ìš©í•œ</label>
          <label><input type="checkbox" name="atmosphere" value="ì‚¬ì§„" /> ì‚¬ì§„ / ë·°ë§›ì§‘</label>
          <label><input type="checkbox" name="atmosphere" value="ì•„ëŠ‘í•œ" /> ì•„ëŠ‘í•œ</label>
        </div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">ë©”ë‰´</div>
        <div class="filter-options">
          <label><input type="checkbox" name="taste" value="ì»¤í”¼" /> ì»¤í”¼</label>
          <label><input type="checkbox" name="taste" value="ë””ì €íŠ¸" /> ë””ì €íŠ¸</label>
          <label><input type="checkbox" name="taste" value="ë¹µ" /> ë¹µ</label>
          <label><input type="checkbox" name="taste" value="ë¸ŒëŸ°ì¹˜" /> ë¸ŒëŸ°ì¹˜</label>
        </div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">ë°©ë¬¸ ëª©ì </div>
        <div class="filter-options">
          <label><input type="checkbox" name="purpose" value="ë°ì´íŠ¸" /> ë°ì´íŠ¸</label>
          <label><input type="checkbox" name="purpose" value="ê³µë¶€" /> ê³µë¶€ / ì‘ì—…</label>
          <label><input type="checkbox" name="purpose" value="ì¹´í˜ íˆ¬ì–´" /> ì¹´í˜ íˆ¬ì–´</label>
          <label><input type="checkbox" name="purpose" value="ìˆ˜ë‹¤" /> ìˆ˜ë‹¤</label>
        </div>
      </div>

      <div class="filter-actions">
        <button class="search-btn" onclick="searchCafes()">ê²€ìƒ‰</button>
        <button class="reset-btn" onclick="resetFilters()">ì´ˆê¸°í™”</button>
      </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½: ì§€ë„ + ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
    <main class="main">
      <div id="map"></div>
      <div class="result-list" id="resultList"></div>
    </main>
  </div>

  <script>
    let map;
    let markers = [];
    let infoWindow;

    function initMap() {
      const container = document.getElementById("map");
      const options = {
        center: new kakao.maps.LatLng(35.1595454, 126.8526012),
        level: 8
      };
      map = new kakao.maps.Map(container, options);
      infoWindow = new kakao.maps.InfoWindow({ removable: true });
    }

    function getCheckedValues(name) {
      return Array.from(document.querySelectorAll('input[name="' + name + '"]:checked'))
        .map((el) => el.value);
    }

    function resetFilters() {
      document.querySelectorAll("aside.sidebar input[type=checkbox]").forEach((el) => {
        el.checked = false;
      });
      clearMarkers();
      document.getElementById("resultList").innerHTML = "";
    }

    function clearMarkers() {
      markers.forEach((m) => m.setMap(null));
      markers = [];
    }

    async function searchCafes() {
      const prefs = {
        region: getCheckedValues("region"),
        atmosphere: getCheckedValues("atmosphere"),
        taste: getCheckedValues("taste"),
        purpose: getCheckedValues("purpose")
      };

      try {
        const res = await fetch("/filter", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(prefs)
        });

        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);

        const data = await res.json();
        const results = data.results || [];

        renderResults(results);
        renderMarkers(results);
      } catch (err) {
        console.error(err);
        alert("ì¹´í˜ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
      }
    }

    function renderResults(results) {
      const listEl = document.getElementById("resultList");
      listEl.innerHTML = "";

      if (results.length === 0) {
        listEl.innerHTML = "<div style='font-size:13px;'>ì¡°ê±´ì— ë§ëŠ” ì¹´í˜ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš” ğŸ¥¹</div>";
        return;
      }

      results.forEach((cafe, idx) => {
        const card = document.createElement("div");
        card.className = "result-card";
        card.dataset.index = idx;

        const score = cafe.score != null ? cafe.score.toFixed(2) : "0.00";

        card.innerHTML = `
          <div class="result-name">${cafe.name}
            <span class="result-score">${score}</span>
          </div>
          <div class="result-meta">${cafe.region || ""} Â· ${(cafe.atmosphere || "").replace(/\|/g, ", ")}</div>
          <div class="result-addr">${cafe.address || ""}</div>
        `;

        card.addEventListener("click", () => focusMarker(idx));
        listEl.appendChild(card);
      });
    }

    function renderMarkers(results) {
      clearMarkers();
      if (results.length === 0) return;

      const bounds = new kakao.maps.LatLngBounds();

      results.forEach((cafe, idx) => {
        if (!cafe.y || !cafe.x) return;

        const position = new kakao.maps.LatLng(cafe.y, cafe.x);
        const marker = new kakao.maps.Marker({ map, position });

        kakao.maps.event.addListener(marker, "click", () => {
          const content = `
            <div style="padding:5px;font-size:12px;">
              <div style="font-weight:600;margin-bottom:4px;">${cafe.name}</div>
              <div style="margin-bottom:2px;">${cafe.address || ""}</div>
              ${cafe.url ? `<a href="${cafe.url}" target="_blank" style="color:#2f80ed;">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>` : ""}
            </div>
          `;
          infoWindow.setContent(content);
          infoWindow.open(map, marker);
        });

        markers.push(marker);
        bounds.extend(position);
      });

      if (!bounds.isEmpty()) {
        map.setBounds(bounds);
      }
    }

    function focusMarker(index) {
      const marker = markers[index];
      if (!marker) return;

      const pos = marker.getPosition();
      map.setLevel(4);
      map.panTo(pos);
      kakao.maps.event.trigger(marker, "click");
    }

    let isSidebarOpen = true;
    function toggleSidebar() {
      const layout = document.querySelector(".layout");
      const btn = document.querySelector(".sidebar-toggle");

      isSidebarOpen = !isSidebarOpen;

      if (isSidebarOpen) {
        layout.classList.remove("sidebar-collapsed");
        btn.textContent = "í•„í„° ë‹«ê¸°";
      } else {
        layout.classList.add("sidebar-collapsed");
        btn.textContent = "í•„í„° ì—´ê¸°";
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>
